---
import katalogusData from '../../katalogus.json';
const katalogus = katalogusData || {};
---

<html lang="hu">
<head>
    <meta charset="utf-8" />
    <title>Okosotthon Tervez≈ë</title>
    <style is:global>
        body { 
            background-color: #191919; 
            color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 40px; 
            margin: 0; 
        }

        h1 { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-bottom: 1px solid #2f2f2f; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }

        .controls {
            background-color: #202020;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            border: 1px solid #2d2d2d;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        input, select {
            background-color: #2a2a2a;
            border: 1px solid #3d3d3d;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
        }

        button {
            padding: 10px 18px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-yellow { background-color: #f1c40f; color: #2c2c2c; }
        .btn-del {
            background-color: rgba(255, 71, 87, 0.1);
            color: #ff6b81;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 10px 20px; font-size: 0.75rem; color: #888; }

        tbody tr { background-color: #202020; }
        td { padding: 16px 20px; color: #ddd; }

        .tag-room { background:#333; padding:6px 12px; border-radius:6px; }
        .badge-protocol { padding:6px 12px; border-radius:6px; font-weight:700; font-size:0.75rem; }
        .zigbee { background:#e67e22; color:#fff; }
        .wifi { background:#2980b9; color:#fff; }
        .bluetooth { background:#2c3e50; color:#fff; }
        .egyeb { background:#555; color:#ccc; }

        .badge-status { padding:6px 14px; border-radius:20px; font-size:0.75rem; }
        .status-tervezett { background:#3e2a4f; color:#d8b4fe; }

        .price { color:#2ecc71; font-weight:bold; font-family:monospace; }
        #grandTotal { font-size:1.2rem; color:#2ecc71; }
    </style>
</head>

<body>
<h1>üè† Okosotthon Tervez≈ë</h1>

<div class="controls">
    <input type="text" id="clientName" placeholder="√úgyf√©l neve..." />
    <button class="btn-blue" onclick="saveProject()">üíæ Ment√©s</button>
    <button class="btn-yellow" onclick="openLoadPopup()">üìÇ Bet√∂lt√©s</button>

    <div style="flex-grow:1"></div>

    <select id="deviceSelect">
        <option value="">-- V√°lassz eszk√∂zt --</option>
        {Object.keys(katalogus).map(id => <option value={id}>{id}</option>)}
    </select>

    <input type="text" id="roomInput" placeholder="Helyis√©g" />
    <input type="number" id="qtyInput" value="1" min="1" style="width:60px;" />
    <button class="btn-green" onclick="addDevice()">‚ûï Hozz√°ad</button>
</div>

<table>
<thead>
<tr>
    <th>Helyis√©g</th>
    <th>Eszk√∂z</th>
    <th>Protokoll</th>
    <th>Db</th>
    <th>√ñsszesen</th>
    <th>√Ållapot</th>
    <th></th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
<tfoot>
<tr>
    <td colspan="4" style="text-align:right">V√©g√∂sszeg:</td>
    <td id="grandTotal">0 Ft</td>
</tr>
</tfoot>
</table>

<!-- LOAD POPUP -->
<div id="loadPopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:999; align-items:center; justify-content:center;">
    <div style="background:#202020; padding:20px; border-radius:12px; min-width:300px;">
        <h3>üìÇ Mentett √ºgyfelek</h3>
        <div id="projectList"></div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn-del" onclick="closeLoadPopup()">Bez√°r</button>
        </div>
    </div>
</div>

<script define:vars={{ katalogus }}>
let currentProject = [];

window.addDevice = () => {
    const id = deviceSelect.value;
    if(!id) return;
    currentProject.push({ id, room: roomInput.value || 'Nincs', qty: +qtyInput.value, status:'Tervezett' });
    roomInput.value='';
    render();
};

window.render = () => {
    tableBody.innerHTML='';
    let sum=0;
    currentProject.forEach((i,idx)=>{
        const info = katalogus[i.id] || {price:0,protocol:'Egy√©b'};
        sum += i.qty*info.price;
        tableBody.innerHTML += `
        <tr>
            <td><span class="tag-room">${i.room}</span></td>
            <td>${i.id}</td>
            <td><span class="badge-protocol ${(info.protocol||'egyeb').toLowerCase()}">${info.protocol}</span></td>
            <td>${i.qty}</td>
            <td class="price">${(i.qty*info.price).toLocaleString()} Ft</td>
            <td><span class="badge-status status-tervezett">${i.status}</span></td>
            <td><button class="btn-del" onclick="remove(${idx})">‚úï</button></td>
        </tr>`;
    });
    grandTotal.innerText = sum.toLocaleString()+' Ft';
};

window.remove = i => { currentProject.splice(i,1); render(); };

window.saveProject = async () => {
    if(clientName.value) {
        // Lok√°lisan ment√©s
        localStorage.setItem('proj_'+clientName.value, JSON.stringify(currentProject));
        
        // Szerver oldali ment√©s JSON f√°jlba
        try {
            const response = await fetch('/api/projects.json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'save',
                    name: clientName.value,
                    data: currentProject
                })
            });
            const result = await response.json();
            if(result.success) {
                alert('Projekt mentve! (Lok√°lisan √©s szerverr≈ël is)');
            } else {
                alert('Hiba: ' + result.message);
            }
        } catch(e) {
            console.error('Szerver hiba:', e);
            alert('Szerver hiba, de lok√°lisan mentve!');
        }
    }
};

window.openLoadPopup = async () => {
    projectList.innerHTML='';
    
    // Szerverr≈ël bet√∂lt√©s
    try {
        const response = await fetch('/api/projects.json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'list' })
        });
        const result = await response.json();
        if(result.success && result.projects.length > 0) {
            result.projects.forEach(name => {
                projectList.innerHTML += `<button class="btn-blue" style="width:100%;margin-bottom:6px" onclick="loadProjectByName('${name}')">${name}</button>`;
            });
        }
    } catch(e) {
        console.error('Szerver hiba:', e);
    }
    
    // Lok√°lis fallback
    const localProjects = Object.keys(localStorage).filter(k=>k.startsWith('proj_')).map(k=>k.replace('proj_',''));
    if(localProjects.length > 0 && projectList.innerHTML === '') {
        projectList.innerHTML += '<p style="color:#888; margin-bottom:10px;">Csak lok√°lis ment√©sek:</p>';
        localProjects.forEach(name=>{
            projectList.innerHTML += `<button class="btn-blue" style="width:100%;margin-bottom:6px" onclick="loadProjectByName('${name}')">${name}</button>`;
        });
    }
    
    loadPopup.style.display='flex';
};

window.closeLoadPopup = ()=> loadPopup.style.display='none';

window.loadProjectByName = async name => {
    // Szerverr≈ël pr√≥b√°ld bet√∂lteni el≈ësz√∂r
    try {
        const response = await fetch('/api/projects.json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'load', name: name })
        });
        const result = await response.json();
        if(result.success) {
            currentProject = result.data;
            clientName.value = name;
            render();
            closeLoadPopup();
            return;
        }
    } catch(e) {
        console.error('Szerver hiba:', e);
    }
    
    // Lok√°lis fallback
    const data = localStorage.getItem('proj_'+name);
    if(data){
        currentProject = JSON.parse(data);
        clientName.value = name;
        render();
        closeLoadPopup();
    }
};
</script>
</body>
</html>

---
import katalogusData from '../../katalogus.json';
const katalogus = katalogusData || {};
---

<html lang="hu">
<head>
    <meta charset="utf-8" />
    <title>Okosotthon Tervez≈ë</title>
    <style is:global>
        body { 
            background-color: #191919; 
            color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 40px; 
            margin: 0; 
        }

        h1 { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-bottom: 1px solid #2f2f2f; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }

        .controls {
            background-color: #202020;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            border: 1px solid #2d2d2d;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        input, select {
            background-color: #2a2a2a;
            border: 1px solid #3d3d3d;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
        }

        button {
            padding: 10px 18px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-yellow { background-color: #f1c40f; color: #2c2c2c; }
        .btn-del {
            background-color: rgba(255, 71, 87, 0.1);
            color: #ff6b81;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 10px 20px; font-size: 0.75rem; color: #888; }

        tbody tr { background-color: #202020; }
        td { padding: 16px 20px; color: #ddd; }

        .tag-room { background:#333; padding:6px 12px; border-radius:6px; }
        .badge-protocol { padding:6px 12px; border-radius:6px; font-weight:700; font-size:0.75rem; }
        .zigbee { background:#e67e22; color:#fff; }
        .wifi { background:#2980b9; color:#fff; }
        .bluetooth { background:#2c3e50; color:#fff; }
        .egyeb { background:#555; color:#ccc; }

        .badge-status { padding:6px 14px; border-radius:20px; font-size:0.75rem; }
        .status-tervezett { background:#3e2a4f; color:#d8b4fe; }

        .price { color:#2ecc71; font-weight:bold; font-family:monospace; }
        #grandTotal { font-size:1.2rem; color:#2ecc71; }
        
        /* Popup st√≠lusok */
        .popup {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }
        
        .popup-content {
            background: #202020;
            padding: 25px;
            border-radius: 12px;
            min-width: 400px;
            max-width: 500px;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .popup-footer {
            text-align: right;
            margin-top: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .help-text {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>

<body>
<h1>üè† Okosotthon Tervez≈ë</h1>

<div class="controls">
    <input type="text" id="clientName" placeholder="√úgyf√©l neve..." />
    <button class="btn-blue" onclick="saveProject()">üíæ Ment√©s</button>
    <button class="btn-yellow" onclick="openLoadPopup()">üìÇ Bet√∂lt√©s</button>
    <button class="btn-green" onclick="openSettingsPopup()">‚öôÔ∏è Be√°ll√≠t√°sok</button>
    <button class="btn-green" onclick="exportToJSON()">üì• Export JSON</button>

    <div style="flex-grow:1"></div>

    <select id="deviceSelect">
        <option value="">-- V√°lassz eszk√∂zt --</option>
        {Object.keys(katalogus).map(id => <option value={id}>{id}</option>)}
    </select>

    <input type="text" id="roomInput" placeholder="Helyis√©g" />
    <input type="number" id="qtyInput" value="1" min="1" style="width:60px;" />
    <button class="btn-green" onclick="addDevice()">‚ûï Hozz√°ad</button>
</div>

<table>
<thead>
<tr>
    <th>Helyis√©g</th>
    <th>Eszk√∂z</th>
    <th>Protokoll</th>
    <th>Db</th>
    <th>√ñsszesen</th>
    <th>√Ållapot</th>
    <th></th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
<tfoot>
<tr>
    <td colspan="4" style="text-align:right">V√©g√∂sszeg:</td>
    <td id="grandTotal">0 Ft</td>
</tr>
</tfoot>
</table>

<!-- LOAD POPUP -->
<div id="loadPopup" class="popup">
    <div class="popup-content">
        <div class="popup-header">
            <h3 style="margin:0">üìÇ Mentett √ºgyfelek</h3>
            <button class="btn-del" style="padding:5px 10px" onclick="closeLoadPopup()">‚úï</button>
        </div>
        <div id="projectList"></div>
        <div class="popup-footer">
            <button class="btn-del" onclick="closeLoadPopup()">Bez√°r</button>
        </div>
    </div>
</div>

<!-- SETTINGS POPUP -->
<div id="settingsPopup" class="popup">
    <div class="popup-content">
        <div class="popup-header">
            <h3 style="margin:0">‚öôÔ∏è GitHub Be√°ll√≠t√°sok</h3>
            <button class="btn-del" style="padding:5px 10px" onclick="closeSettingsPopup()">‚úï</button>
        </div>
        
        <div class="input-group">
            <label for="githubToken">GitHub Personal Access Token:</label>
            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width:100%" />
            <div class="help-text">
                <a href="https://github.com/settings/tokens" target="_blank" style="color:#2980b9; text-decoration:none">
                    üîó Token l√©trehoz√°sa itt
                </a>
                <br>Scope: <code>gist</code> (csak ezt pip√°ld be!)
            </div>
        </div>
        
        <div class="input-group">
            <label for="gistId">Gist ID (opcion√°lis):</label>
            <input type="text" id="gistId" placeholder="xxxxxxxxxxxxxxxxxxxx" style="width:100%" />
            <div class="help-text">
                Ha m√°r van ment≈ë Gist-ed, add meg az ID-j√°t.<br>
                √úresen hagyva √∫j Gist j√∂n l√©tre automatikusan.
            </div>
        </div>
        
        <div class="input-group">
            <label for="syncCode">Szinkroniz√°l√°si k√≥d:</label>
            <input type="text" id="syncCode" readonly style="width:100%; background:#2a2a2a; color:#888; cursor:pointer" onclick="copySyncCode()" />
            <div class="help-text">
                Kattints a m√°sol√°shoz. Ezt a k√≥dot b√°rmelyik eszk√∂z√∂n be√≠rhatod a be√°ll√≠t√°sokban.
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="btn-green" onclick="saveSettings()">üíæ Be√°ll√≠t√°sok ment√©se</button>
            <button class="btn-del" onclick="closeSettingsPopup()">M√©gse</button>
        </div>
    </div>
</div>

<!-- SYNC POPUP -->
<div id="syncPopup" class="popup">
    <div class="popup-content">
        <div class="popup-header">
            <h3 style="margin:0">üîÑ Eszk√∂z szinkroniz√°l√°s</h3>
            <button class="btn-del" style="padding:5px 10px" onclick="closeSyncPopup()">‚úï</button>
        </div>
        
        <div class="input-group">
            <label for="importSyncCode">Szinkroniz√°l√°si k√≥d:</label>
            <textarea id="importSyncCode" placeholder="Illeszd be a m√°sik eszk√∂zr≈ël m√°solt k√≥dot..." style="width:100%; height:100px; font-family:monospace; background:#2a2a2a; color:#fff; border:1px solid #3d3d3d; padding:10px; border-radius:6px"></textarea>
            <div class="help-text">
                M√°s eszk√∂z√∂n: Be√°ll√≠t√°sok ‚Üí Szinkroniz√°l√°si k√≥d ‚Üí M√°sol√°s<br>
                Itt: Illeszd be ‚Üí Import√°l√°s
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="btn-green" onclick="importSyncCode()">üì• Import√°l√°s</button>
            <button class="btn-del" onclick="closeSyncPopup()">M√©gse</button>
        </div>
    </div>
</div>

<script define:vars={{ katalogus }}>
let currentProject = [];
let GITHUB_TOKEN = '';
let GIST_ID = '';

// ============ INICIALIZ√ÅCI√ì ============
function initApp() {
    // Token bet√∂lt√©se localStorage-b≈ël
    GITHUB_TOKEN = localStorage.getItem('okos_github_token') || '';
    GIST_ID = localStorage.getItem('okos_gist_id') || '';
    
    // Sync code gener√°l√°sa
    updateSyncCode();
    
    // Ellen≈ërizz√ºk, hogy van-e token
    checkGitHubToken();
    
    // Alap√©rtelmezett render
    render();
}

// ============ TOKEN ELLEN≈êRZ√âS ============
function checkGitHubToken() {
    if (!GITHUB_TOKEN || GITHUB_TOKEN.length < 20) {
        console.log('Nincs GitHub token be√°ll√≠tva. Az alkalmaz√°s csak helyileg fog m≈±k√∂dni.');
        
        // Csak akkor aj√°nljuk fel a be√°ll√≠t√°st, ha m√©g nem volt
        const hasSeenWarning = localStorage.getItem('okos_has_seen_token_warning');
        if (!hasSeenWarning) {
            setTimeout(() => {
                const setup = confirm(
                    '√údv√∂z√∂llek az Okosotthon Tervez≈ëben!\n\n' +
                    'A GitHub Gist-be ment√©shez token sz√ºks√©ges.\n' +
                    'Szeretn√©l most be√°ll√≠tani?\n\n' +
                    '‚úÖ Igen: Token be√°ll√≠t√°sa\n' +
                    '‚ùå Nem: Csak helyi ment√©s (b√∂ng√©sz≈ëben marad)'
                );
                
                if (setup) {
                    openSettingsPopup();
                } else {
                    localStorage.setItem('okos_has_seen_token_warning', 'true');
                }
            }, 1500);
        }
    }
}

// ============ ALAP FUNKCI√ìK ============
window.addDevice = () => {
    const id = deviceSelect.value;
    if(!id) return;
    currentProject.push({ 
        id, 
        room: roomInput.value || 'Nincs', 
        qty: +qtyInput.value, 
        status:'Tervezett' 
    });
    roomInput.value = '';
    render();
};

window.render = () => {
    tableBody.innerHTML = '';
    let sum = 0;
    
    currentProject.forEach((i, idx) => {
        const info = katalogus[i.id] || {price: 0, protocol: 'Egy√©b'};
        sum += i.qty * info.price;
        
        tableBody.innerHTML += `
        <tr>
            <td><span class="tag-room">${i.room}</span></td>
            <td>${i.id}</td>
            <td><span class="badge-protocol ${(info.protocol||'egyeb').toLowerCase()}">${info.protocol}</span></td>
            <td>${i.qty}</td>
            <td class="price">${(i.qty * info.price).toLocaleString()} Ft</td>
            <td><span class="badge-status status-tervezett">${i.status}</span></td>
            <td><button class="btn-del" onclick="remove(${idx})">‚úï</button></td>
        </tr>`;
    });
    
    grandTotal.innerText = sum.toLocaleString() + ' Ft';
};

window.remove = i => { 
    currentProject.splice(i, 1); 
    render(); 
};

// ============ MENT√âS (GitHub + Local) ============
window.saveProject = async () => {
    const name = clientName.value.trim();
    if(!name) {
        alert('K√©rj√ºk adja meg az √ºgyf√©l nev√©t!');
        return;
    }

    try {
        // 1. Mindig mentj√ºk localStorage-ba
        localStorage.setItem('okos_proj_' + name, JSON.stringify({
            clientName: name,
            project: currentProject,
            savedAt: new Date().toISOString(),
            version: '1.0'
        }));

        // 2. GitHub ment√©s (ha van token)
        if (GITHUB_TOKEN && GITHUB_TOKEN.length > 20) {
            await saveToGitHubGist(name);
            alert('‚úÖ Projekt mentve!\n\n‚Ä¢ Helyi t√°rol√≥ba\n‚Ä¢ GitHub Gist-be');
        } else {
            // Csak helyi ment√©s
            alert('‚úÖ Projekt mentve helyi t√°rol√≥ba!\n\nGitHub token nincs be√°ll√≠tva a felh≈ës ment√©shez.');
        }
    } catch(error) {
        console.error('Ment√©si hiba:', error);
        alert('‚ö†Ô∏è Hiba t√∂rt√©nt: ' + error.message);
    }
};

// ============ GITHUB GIST MENT√âS ============
async function saveToGitHubGist(projectName) {
    const gistData = {
        description: `Okosotthon projekt: ${projectName} - ${new Date().toLocaleDateString('hu-HU')}`,
        public: false,
        files: {
            [`${projectName}.json`]: {
                content: JSON.stringify({
                    clientName: projectName,
                    project: currentProject,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                }, null, 2)
            }
        }
    };

    let url = 'https://api.github.com/gists';
    let method = 'POST';
    
    // Ha van GIST_ID, akkor update
    if (GIST_ID) {
        url = `https://api.github.com/gists/${GIST_ID}`;
        method = 'PATCH';
        
        try {
            // Lek√©rj√ºk a l√©tez≈ë Gist-et
            const existingResponse = await fetch(url, {
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (existingResponse.ok) {
                const existingGist = await existingResponse.json();
                // Megtartjuk a r√©gi f√°jlokat is
                gistData.files = {
                    ...existingGist.files,
                    ...gistData.files
                };
            }
        } catch(e) {
            console.log('√öj f√°jl l√©trehoz√°sa a Gist-ben');
        }
    }

    const response = await fetch(url, {
        method: method,
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify(gistData)
    });

    const result = await response.json();
    
    if(response.ok) {
        // Mentj√ºk az √∫j GIST_ID-t ha √∫j Gist j√∂tt l√©tre
        if (!GIST_ID && result.id) {
            GIST_ID = result.id;
            localStorage.setItem('okos_gist_id', GIST_ID);
            updateSyncCode(); // Friss√≠tj√ºk a sync k√≥dot
        }
        
        console.log('GitHub ment√©s sikeres:', result.html_url);
        return true;
    } else {
        throw new Error(result.message || 'GitHub API hiba');
    }
}

// ============ BET√ñLT√âS ============
window.openLoadPopup = async () => {
    try {
        projectList.innerHTML = '<p style="color:#888;text-align:center">Bet√∂lt√©s...</p>';
        loadPopup.style.display = 'flex';
        
        let projects = [];
        
        // 1. Helyi projektek
        Object.keys(localStorage).forEach(k => {
            if(k.startsWith('okos_proj_')) {
                projects.push(k.replace('okos_proj_', ''));
            }
        });
        
        // 2. GitHub projektek (ha van token √©s Gist ID)
        if (GITHUB_TOKEN && GITHUB_TOKEN.length > 20 && GIST_ID) {
            try {
                const githubProjects = await getGitHubProjects();
                githubProjects.forEach(project => {
                    if (!projects.includes(project)) {
                        projects.push(project);
                    }
                });
            } catch(githubError) {
                console.warn('GitHub bet√∂lt√©si hiba:', githubError);
            }
        }
        
        // Lista megjelen√≠t√©se
        projectList.innerHTML = '';
        
        if(projects.length === 0) {
            projectList.innerHTML = '<p style="color:#888;text-align:center">Nincs mentett projekt</p>';
        } else {
            projects.forEach(name => {
                projectList.innerHTML += `
                    <div style="display:flex; gap:10px; margin-bottom:8px; align-items:center">
                        <button class="btn-blue" style="flex-grow:1" onclick="loadProject('${name}')">${name}</button>
                        <button class="btn-del" onclick="deleteProject('${name}')">T√∂rl√©s</button>
                    </div>`;
            });
        }
        
    } catch(error) {
        alert('Hiba a projektek bet√∂lt√©se sor√°n');
        console.error(error);
    }
};

async function getGitHubProjects() {
    const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('GitHub bet√∂lt√©s sikertelen');
    }
    
    const gist = await response.json();
    const projects = [];
    
    if (gist.files) {
        Object.keys(gist.files).forEach(fileName => {
            if (fileName.endsWith('.json')) {
                projects.push(fileName.replace('.json', ''));
            }
        });
    }
    
    return projects;
}

window.closeLoadPopup = () => loadPopup.style.display = 'none';

window.loadProject = async (name) => {
    let projectData = null;
    
    // El≈ësz√∂r helyi t√°rol√≥b√≥l
    const localData = localStorage.getItem('okos_proj_' + name);
    if (localData) {
        projectData = JSON.parse(localData);
    }
    
    // Ha nincs helyben √©s van GitHub token, akkor GitHub-r√≥l
    if (!projectData && GITHUB_TOKEN && GITHUB_TOKEN.length > 20 && GIST_ID) {
        try {
            const githubData = await loadFromGitHub(name);
            if (githubData) {
                projectData = githubData;
                // Elmentj√ºk helyire is a j√∂v≈ëbeli gyors el√©r√©shez
                localStorage.setItem('okos_proj_' + name, JSON.stringify(projectData));
            }
        } catch(error) {
            console.log('GitHub bet√∂lt√©s sikertelen:', error);
        }
    }
    
    if (projectData) {
        currentProject = projectData.project || projectData;
        clientName.value = projectData.clientName || name;
        render();
        closeLoadPopup();
        alert(`Projekt bet√∂ltve: ${name}`);
    } else {
        alert(`Projekt nem tal√°lhat√≥: ${name}`);
    }
};

async function loadFromGitHub(name) {
    const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('GitHub bet√∂lt√©s sikertelen');
    }
    
    const gist = await response.json();
    const fileName = `${name}.json`;
    
    if (gist.files && gist.files[fileName]) {
        const content = gist.files[fileName].content;
        return JSON.parse(content);
    }
    
    return null;
}

// ============ T√ñRL√âS ============
window.deleteProject = async (name) => {
    if(!confirm(`Biztosan t√∂r√∂lni szeretn√© a(z) "${name}" projektet?\n\nEz a t√∂rl√©s v√©gleges!`)) {
        return;
    }

    // 1. Helyi t√∂rl√©s
    localStorage.removeItem('okos_proj_' + name);
    
    // 2. GitHub t√∂rl√©s (ha van token √©s Gist ID)
    if (GITHUB_TOKEN && GITHUB_TOKEN.length > 20 && GIST_ID) {
        try {
            await deleteFromGitHub(name);
        } catch(error) {
            console.log('GitHub t√∂rl√©s sikertelen:', error);
        }
    }
    
    alert('Projekt t√∂r√∂lve!');
    openLoadPopup(); // Friss√≠ti a list√°t
};

async function deleteFromGitHub(name) {
    const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('Gist bet√∂lt√©s sikertelen');
    }
    
    const gist = await response.json();
    const fileName = `${name}.json`;
    
    if (gist.files && gist.files[fileName]) {
        // T√∂r√∂lj√ºk a f√°jlt a Gist-b≈ël
        gist.files[fileName] = null;
        
        // Friss√≠tj√ºk a Gist-et
        await fetch(`https://api.github.com/gists/${GIST_ID}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                files: gist.files
            })
        });
    }
}

// ============ BE√ÅLL√çT√ÅSOK ============
window.openSettingsPopup = () => {
    githubToken.value = GITHUB_TOKEN;
    gistId.value = GIST_ID;
    updateSyncCode();
    settingsPopup.style.display = 'flex';
};

window.closeSettingsPopup = () => settingsPopup.style.display = 'none';

window.saveSettings = () => {
    const newToken = githubToken.value.trim();
    const newGistId = gistId.value.trim();
    
    // Token valid√°ci√≥
    if (newToken && newToken.length < 20) {
        alert('√ârv√©nytelen token! A tokennek legal√°bb 20 karakter hossz√∫nak kell lennie.');
        return;
    }
    
    // Token tesztel√©se (ha √∫j token van)
    if (newToken && newToken !== GITHUB_TOKEN) {
        if (!confirm('√öj tokent √°ll√≠tasz be. Szeretn√©d tesztelni a tokent?')) {
            saveSettingsToStorage(newToken, newGistId);
            return;
        }
        
        testGitHubToken(newToken).then(isValid => {
            if (isValid) {
                saveSettingsToStorage(newToken, newGistId);
                alert('‚úÖ Token √©rv√©nyes! Be√°ll√≠t√°sok mentve.');
            } else {
                alert('‚ùå Token √©rv√©nytelen! K√©rlek ellen≈ërizd a tokent.');
            }
        }).catch(error => {
            alert('‚ùå Token tesztel√©s sikertelen: ' + error.message);
        });
    } else {
        saveSettingsToStorage(newToken, newGistId);
        alert('Be√°ll√≠t√°sok mentve!');
    }
};

function saveSettingsToStorage(token, gistId) {
    GITHUB_TOKEN = token;
    GIST_ID = gistId;
    
    localStorage.setItem('okos_github_token', token);
    localStorage.setItem('okos_gist_id', gistId);
    
    updateSyncCode();
    closeSettingsPopup();
}

async function testGitHubToken(token) {
    const response = await fetch('https://api.github.com/user', {
        headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    return response.ok;
}

// ============ SZINKRONIZ√ÅCI√ìS K√ìD ============
function updateSyncCode() {
    // L√©trehozunk egy sync k√≥dot a be√°ll√≠t√°sokhoz
    const syncData = {
        token: GITHUB_TOKEN,
        gistId: GIST_ID,
        version: '1.0',
        timestamp: new Date().toISOString()
    };
    
    // Base64 k√≥dol√°s
    const syncCode = btoa(JSON.stringify(syncData));
    syncCode.value = syncCode;
}

window.copySyncCode = () => {
    syncCode.select();
    document.execCommand('copy');
    alert('‚úÖ Szinkroniz√°l√°si k√≥d m√°solva!\n\nM√°s eszk√∂z√∂n: Be√°ll√≠t√°sok ‚Üí Szinkroniz√°l√°si k√≥d mez≈ë ‚Üí Illeszd be ‚Üí Import√°l√°s');
};

window.openSyncPopup = () => {
    syncPopup.style.display = 'flex';
};

window.closeSyncPopup = () => syncPopup.style.display = 'none';

window.importSyncCode = () => {
    const code = importSyncCode.value.trim();
    if (!code) {
        alert('K√©rlek illess be egy szinkroniz√°l√°si k√≥dot!');
        return;
    }
    
    try {
        // Base64 dek√≥dol√°s
        const decoded = atob(code);
        const syncData = JSON.parse(decoded);
        
        if (!syncData.token || syncData.token.length < 20) {
            throw new Error('√ârv√©nytelen token a k√≥dban');
        }
        
        // Be√°ll√≠t√°sok ment√©se
        GITHUB_TOKEN = syncData.token;
        GIST_ID = syncData.gistId || '';
        
        localStorage.setItem('okos_github_token', GITHUB_TOKEN);
        localStorage.setItem('okos_gist_id', GIST_ID);
        
        updateSyncCode();
        closeSyncPopup();
        
        alert('‚úÖ Eszk√∂z szinkroniz√°lva!\n\nGitHub token √©s Gist ID sikeresen import√°lva.');
    } catch(error) {
        alert('‚ùå Hiba a szinkroniz√°l√°si k√≥d feldolgoz√°sakor: ' + error.message);
    }
};

// ============ JSON EXPORT ============
window.exportToJSON = () => {
    const name = clientName.value.trim() || 'unnamed_project';
    
    const data = {
        clientName: name,
        project: currentProject,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `okosotthon-${name}-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`Projekt export√°lva: ${a.download}\n\nMentsd el a f√°jlt, √©s k√©s≈ëbb visszat√∂ltheted.`);
};

// ============ ALKALMAZ√ÅS IND√çT√ÅSA ============
initApp();
</script>
</body>
</html>